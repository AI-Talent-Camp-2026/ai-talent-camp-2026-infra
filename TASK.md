–í–æ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ **—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–¢–ó)** –¥–ª—è –∞–≥–µ–Ω—Ç–∞/–∫–æ–ª–ª–µ–≥–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä—É—é –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ ‚Äî –æ—Ç initial setup –¥–æ –≥–æ—Ç–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø–æ–¥ —Ö–∞–∫–∞—Ç–æ–Ω. –î–æ–∫—É–º–µ–Ω—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ **—á—ë—Ç–∫–∏–µ —à–∞–≥–∏, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –≥–¥–µ –∏ –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å**, —Å —É—á—ë—Ç–æ–º —Ç–æ–≥–æ, —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ **Terraform + cloud-init**, –Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –µ—ë –±—É–¥–µ–º –≤—Ä—É—á–Ω—É—é (CI/CD –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è).
–ù–∞ —Å–ª—É—á–∞–π —Ä–∞–±–æ—Ç—ã —Å Vaultwarden ‚Äî –ø—Ä–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ —Ç–æ–∂–µ –µ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

---

# üìå –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã AI-Camp (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏, —Å–µ—Ä–≤–µ—Ä NAT/edge, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ team-VM)

---

## üß© –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–¶–µ–ª—å:** —Å–æ–∑–¥–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏ —É–ø—Ä–∞–≤–ª—è–µ–º—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ Yandex Cloud —Å –æ–¥–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∞, –≥–¥–µ –∫–æ–º–∞–Ω–¥—ã —Ö–æ—Å—Ç—è—Ç —Å–≤–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SSH —á–µ—Ä–µ–∑ jump-host, –∞ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Xray/VLESS –ø–æ –Ω—É–∂–Ω—ã–º –¥–æ–º–µ–Ω–∞–º.

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **–ü—É–±–ª–∏—á–Ω—ã–π edge/NAT-—Å–µ—Ä–≤–µ—Ä** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π IP, Traefik, jump-host, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è egress —á–µ—Ä–µ–∑ Xray/VLESS.
2. **Private subnet** ‚Äî team-VM –±–µ–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö IP.
3. **Static routing** ‚Äî private subnet –∏—Å–ø–æ–ª—å–∑—É–µ—Ç edge/NAT –∫–∞–∫ next hop.
4. **DNS** ‚Äî `*.camp.aitalenthub.ru` ‚Üí edge IP.

---

## üõ† Phase I ‚Äî Manual Setup + Baseline

### 1) –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–µ–π

#### –ó–∞–¥–∞—á–∞

–ü–æ—Å—Ç—Ä–æ–∏—Ç—å VPC —Å –¥–≤—É–º—è –ø–æ–¥—Å–µ—Ç—è–º–∏.

#### –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å

* —Å–æ–∑–¥–∞—Ç—å VPC;
* —Å–æ–∑–¥–∞—Ç—å **public subnet** –¥–ª—è edge/NAT;
* —Å–æ–∑–¥–∞—Ç—å **private subnet** –¥–ª—è team-VM.
* –ø—Ä–∏–≤—è–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã:
  private subnet ‚Üí NAT edge VM (—Å–º. tutorial Yandex Cloud). ([yandex.cloud][1])

---

### 2) NAT/edge VM

#### –ß—Ç–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Ä—É—á–Ω—É—é

* Ubuntu/Debian VM –≤ public subnet —Å –ø—É–±–ª–∏—á–Ω—ã–º IP;
* security group —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:

  * –ø–æ—Ä—Ç 22 (SSH)
  * –ø–æ—Ä—Ç 80/443 (Traefik ingress)
  * –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∫–∞–∫ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä VLESS/GRPC –ø–æ—Ä—Ç—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
* –≤–∫–ª—é—á–∏—Ç—å ip_forward –∏ masquerade –¥–ª—è NAT.

#### –ó–∞–¥–∞—á–∞

–û–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ–±—ã –ª—é–±—ã–µ VM –≤ private subnet –º–æ–≥–ª–∏ –≤—ã—Ö–æ–¥–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç NAT.

---

### 3) DNS –¥–ª—è AI-Camp

#### –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å

* –≤ DNS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ —Å–æ–∑–¥–∞—Ç—å:

  * `*.camp.aitalenthub.ru` ‚Üí –ø—É–±–ª–∏—á–Ω—ã–π IP edge/NAT
  * `bastion.camp.aitalenthub.ru` ‚Üí —Ç–æ—Ç –∂–µ IP
    (—ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —á–µ—Ä–µ–∑ –æ–¥–∏–Ω A-–∑–∞–ø–∏—Å –¥–æ–º–µ–Ω–∞–º–∏ —Ä—É–ª–∏—Ç—å ingress/SSH).

---

### 4) –¢–µ—Å—Ç–æ–≤–∞—è VM

#### –ß—Ç–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

* VM –¥–ª—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã:

  * private subnet,
  * –±–µ–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ IP,
  * security group: SSH (private ‚Üí edge) –∏ service ports (80/443) private ‚Üí edge.

#### –ó–∞–¥–∞—á–∞

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SSH jump-host —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ —á—Ç–æ —Ç—Ä–∞—Ñ–∏–∫ egress —É—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ NAT.

---

### 5) SSH –¥–æ—Å—Ç—É–ø

#### –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é

* –Ω–∞ edge (jump) –≤–∫–ª—é—á–∏—Ç—å `AllowTcpForwarding yes`, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–∞—Ä–æ–ª–∏;
* –Ω–∞ team-VM –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–∏—Ç—å public-–∫–ª—é—á–∏.

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ:

```bash
ssh -J jump@bastion.camp.aitalenthub.ru team01@10.x.x.x
```

—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—è.

---

### 6) Xray/VLESS

#### –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å

–ù–∞ edge:

* —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å Xray (`teddysun/xray:latest`)
* –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å inbound –¥–ª—è transparent proxy
* –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å routing –ø—Ä–∞–≤–∏–ª –¥–ª—è –Ω—É–∂–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ ‚Üí VLESS
* –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí direct

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** routing –ø–æ –¥–æ–º–µ–Ω–∞–º –¥–µ–ª–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ Xray. –°–∞–º NAT –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è iptables + tproxy.
–≠—Ç–æ –¥–∞—ë—Ç –Ω—É–∂–Ω—É—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (AI API –∏ –ø—Ä–æ—á–µ–µ).

---

## üõ† Phase II ‚Äî Automation (Terraform + cloud-init)

> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –ø–æ–∑–≤–æ–ª—è—Ç—å –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ —Å–æ–∑–¥–∞–≤–∞—Ç—å:
>
> * —Å–µ—Ç–µ–≤—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É,
> * NAT/edge VM,
> * private subnet –∏ –º–∞—Ä—à—Ä—É—Ç—ã,
> * team-VM —Å SSH –∫–ª—é—á–∞–º–∏,
> * DNS –∑–∞–ø–∏—Å–∏.

–ö–∞–∂–¥—ã–π —à–∞–≥ –Ω–∏–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ **Terraform –º–æ–¥—É–ª—å**.

---

## üß± Terraform Modules

### 1) Module: `network`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**

* VPC
* public + private subnets

**–í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**

* folder_id, cloud_id
* network name, subnets CIDR
* zones

---

### 2) Module: `security_groups`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**

* SG –¥–ª—è edge
* SG –¥–ª—è team VM

**Ingress/egress –ø—Ä–∞–≤–∏–ª–∞**

* edge: 22/80/443
* team: SSH/TCP —Ç–æ–ª—å–∫–æ –æ—Ç edge SG

---

### 3) Module: `route_table`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**

* —Å–æ–∑–¥–∞—ë—Ç static route:

  * private subnet ‚Üí <edge private IP>
    (—Å–º. Terraform example NAT instance routing). ([yandex.cloud][1])

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** route table –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å private subnet.

---

### 4) Module: `edge_vm`

**–ß—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å**

* Traefik (TLS passthrough –ø–æ —à–∞–±–ª–æ–Ω—É, –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è –µ—Å—Ç—å)
* Xray transparent proxy

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏**

* cloud-init:

  * —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å docker –∏ traefik
  * —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å traefik config –∏–∑ —à–∞–±–ª–æ–Ω–∞
  * —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Xray config –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö routing

**–í–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

* –ø—É–±–ª–∏—á–Ω—ã–π IP
* security group edge

---

### 5) Module: `team_vm`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å**

* —Å–æ–∑–¥–∞—Ç—å VM –≤ private subnet
* –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å SSH –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ cloud-init
* —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ä–µ–¥—É (docker, nginx)
* –æ—Å—Ç–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π nginx + certbot –Ω–∞ team-VM, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–∞–º–∏ –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å certs —á–µ—Ä–µ–∑ HTTP-01

**cloud-init must include**

* user creation
* SSH keys
* optional hands-off nginx bootstrap

---

## üîê –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π

–ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –ø–æ–∫–∞ —á—Ç–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–ø–∫–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –±—ã–ª–æ –ª–µ–≥–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–∏ —Å–µ–∫—Ä–µ—Ç—ã –∫–æ–º–∞–Ω–¥–µ.

---

## üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è

* –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
* –í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
* Outputs
* –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

* –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å team VM –≤—Ä—É—á–Ω—É—é
* –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á –≤ Vaultwarden
* –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é egress —á–µ—Ä–µ–∑ NAT
* Traefik template usage (—Å –ø—Ä–∏–º–µ—Ä–æ–º host rules)

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç—ã (–¥–ª—è –Ω–∞—á–∞–ª–∞)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ NAT works

1. NAT VM —Å–æ–∑–¥–∞–Ω –∏ –∏–º–µ–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π IP
2. route —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ private subnet
3. VM –≤ private subnet –º–æ–∂–µ—Ç –≤—ã–π—Ç–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ NAT (curl ifconfig.co) ([yandex.cloud][1])

---

## üìà –ü—Ä–∏–º–µ—Ä terraform execution flow

```
terraform init
terraform plan \
  -var folder_id=... \
  -var public_subnet_cidr=... \
  -var private_subnet_cidr=...
terraform apply
```

---

## üßë‚Äçüíª –ö–æ–º–∞–Ω–¥—ã –∏ —Ä–æ–ª–∏

| Who   | What                                                |
| ----- | --------------------------------------------------- |
| Infra | terraform apply, DNS update                         |
| Teams | nginx + certbot on their VM, CI/GitHub/GitLab setup |
| Admin | Vaultwarden secret management                       |

---

## üìå –í–∞–∂–Ω–æ (best practices)

1. **–ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ —Ä–µ–ø–æ.**
2. **cloud-init user-data –∑–∞–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ public-–∫–ª—é—á–∏.**
3. **Traefik —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ edge –≤ —Ä–µ–∂–∏–º–µ passthrough.**
4. **Xray –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–æ–¥—É–ª—å–Ω–æ–π** –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å routing –¥–æ–º–µ–Ω–æ–≤.


[1]: https://yandex.cloud/en/docs/tutorials/routing/nat-instance/terraform "Routing through a NAT instance using Terraform"


